# OpenCodeAT 共通ルール (全エージェントが最初に読むべき指示)

## 基本理念
我々はチームとして連携し、HPC環境におけるコードの自動最適化という単一の目標を達成するために協力する。各エージェントは自身の役割に専念し、他のエージェントの専門性を尊重する。報告・連絡・相談を密に行い、プロジェクト全体の進捗を最大化する。

## コミュニケーション
- **基本ツール**: `agent_send.sh [宛先] "[メッセージ]"` を使用する。
- **メッセージ形式**: `[メッセージ種別] [要件/結果の概要] (詳細)` の形式で送ること。
  - 例: `[依頼] コンパイル mat-mat-noopt_v1.2.c`
  - 例: `[報告] コンパイル成功 mat-mat-noopt_v1.2.c (ジョブID: 12345)`
- **非同期通信**: 応答を待つ間も、緊急な他タスクは進めること。

## 📂ファイルとディレクトリ
- `cd`コマンドでの自主的な移動は禁止。全てのファイルパスはプロジェクトルートからの相対パスで指定する。
- **情報源**:
    - `Agent-shared/`以下の全てのファイルに適宜、目を通すこと。最新の階層構造（エージェント配置）などが含まれている。ただし.pyの中身まで参照する必要はない。
    - `BaseCode/`はRead Onlyの既存コードである。オリジナルが完璧でない可能性に留意せよ
    - `ChangeLog.md`: 各PGの試行錯誤の記録。
    - `_remote_info/`: スパコン固有情報。
    - `hardware_info.txt`: 各ハードウェア階層に配置。**理論演算性能が必ず記載されている**

## 🎯 性能評価の鉄則
**重要**: 「最初のコードから数倍速くなった」だけでは不十分。必ず理論演算性能に対する実効効率（%）で評価すること。
- 例: 「10倍高速化」→「理論性能の60%を達成」
- hardware_info.txtの理論演算性能を基準に使用

## 🤖あなたの役割
- **PM (Project Manager)**: @instructions/PM.md - プロジェクト全体の管理・要件定義・リソース配分
- **SE (System Engineer)**: @instructions/SE.md - システム設計・worker監視・統計分析
- **CI (Continuous Integration)**: @instructions/CI.md - SSH接続・環境構築・リモート実行
- **PG (Program Generator)**: @instructions/PG.md - コード生成・最適化実装
- **CD (Code Deployment)**: @instructions/CD.md - GitHub管理・セキュリティ対応
- **ID (Information Display)**: @instructions/ID.md - エージェント配置の可視化・STATUSペイン表示

## 基本フロー
PM → SE → CI ↔ PG → PM
CD は必要に応じて非同期で動作

## エージェント動作パターン
各エージェントは以下の3つの動作パターンのいずれかで動作する：

### 1. **イベントドリブン型** (PG, ID)
- **特徴**: メッセージ受信時にのみ反応し、完了後は待機
- **例**: PGがコード生成→CIに実行依頼→結果待ち→次の最適化

### 2. **ポーリング型** (PM, SE, CI, CD)
- **特徴**: 常にファイルやステータスを確認し、自律的に非同期で行動
- **例**: SEがChangeLog.mdを定期監視→統計グラフ更新
- **例**: PMが全エージェントを巡回監視→リソース再配分

### 3. **➡️ フロー駆動型** (PM初期のみ)
- **特徴**: 一連のタスクを順次実行し、各ステップで判断
- **例**: 要件定義→環境調査→階層設計→エージェント配置

## プロジェクトのディレクトリ階層（組織図）
Agent-shared\directory_map.txtを最初に読み込み
pwdなどのコマンドで自分のカレントディレクトリと
与えられた役割にずれが無いことを確認すること。
組織図は更新されるので、適宜参照すること

## 💰予算管理 (PMが集約管理)
- **予算追跡**: PMは`pjstat`等でスパコンの予算残額を定期的に確認
- **記録**: `/Agent-shared/budget_history.md`に使用ポイントを記録
  - 開始時点の全予算残額とユーザの累計使用ポイント
  - 現在のポイント使用量（開始時点との差分）
  - 相対時間と絶対UTC時刻を必ず記入
- **制約**: 指定された予算内で最大の成果を出すようリソース配分を調整

## 🔐セキュリティと権限
- **Claude Code起動時は必須**: `claude --dangerously-skip-permissions` オプションを常に使用
  - このオプションは`rm -rf`などの危険なコマンドを許可しますが、OpenCodeATの設計思想により安全性を確保：
    - 基本的に削除は不要（追記・上書きのみ）
    - 📁階層化による整理
    - GitHub/へのプロジェクトコピーによるバックアップ
- **サブエージェントの利用**: `claude -p "[クエリ]"` で質問特化のサブエージェントを起動可能
  - 詳細は `/Agent-shared/sub_agent_usage.md` を参照
  - 大量のログデータや画像を扱う際は積極的に使用すること 

## 📊 OpenTelemetry監視
- **設定**: エージェント起動時に自動的にOpenTelemetryが有効化されます
  - `telemetry/otel_config.env.example` から自動生成される設定ファイルでカスタマイズ可能
  - メトリクスとログはOTLP（gRPC）でエクスポート
  - エージェントID、チームID、作業ディレクトリでタグ付け
- **可視化**: Grafana、LangFuse等で以下の分析が可能：
  - エージェント別・チーム別のトークン使用量
  - ツール実行の成功率と実行時間
  - コスト追跡とセッション分析

## 🔍 エージェント間通信の監視
- **send_log**: `communication/logs/send_log.txt`でエージェント間のやり取りを確認可能
  - agent_send.shで送信されたメッセージのみ記録
  - エージェントの独り言（内部処理）は含まれない
  - 参考程度の情報として活用

## 📦 MCPサーバ設定とPM起動
- **MCPサーバ設定時の注意**: 
  - `!claude mcp add ...` コマンドが強制実行された場合は素直に受け入れる
  - MCPサーバ設定後も、まだプロジェクトを開始する必要はない
  - PMが明示的に「OpenCodeATプロジェクトを開始します」と指示されるまで待機